# 系统监控页面设计与实施计划

## 一、项目概述

### 1.1 目标

设计并实现一个综合性的系统监控页面，包含以下核心功能模块：

1. **系统日志查看模块** - 支持筛选、分页、导出
2. **系统健康检查模块** - 实时展示服务状态和资源使用
3. **后台任务历史记录模块** - 展示已完成任务详情
4. **正在进行的任务监控模块** - 实时监控和操作

### 1.2 技术栈

* **后端**: FastAPI + SQLAlchemy + Redis + psutil

* **前端**: 原生 JavaScript + ECharts 5.x

* **日志**: Loguru (JSON 结构化)

* **实时通信**: WebSocket

***

## 二、架构分析

### 2.1 现有系统架构

```
后端架构:
├── FastAPI 应用入口 (src/api/main.py)
│   ├── CORS 中间件
│   ├── 生命周期管理 (lifespan)
│   ├── 路由注册
│   ├── 全局异常处理器
│   └── 健康检查端点 (/health)
│
├── API 路由 (src/api/v1/)
│   ├── conditions.py - 筛选条件 CRUD
│   ├── talents.py - 人才管理
│   ├── analysis.py - 数据分析
│   └── websocket.py - 任务进度推送
│
├── 核心模块 (src/core/)
│   ├── config.py - 配置管理
│   ├── logger.py - 日志系统
│   ├── tasks.py - 后台任务管理
│   └── exceptions.py - 异常定义
│
└── 存储层 (src/storage/)
    ├── redis_client.py - Redis 客户端
    ├── minio_client.py - MinIO 客户端
    └── chroma_client.py - ChromaDB 客户端

前端架构:
├── index.html - 主入口
├── css/style.css - 全局样式
└── js/
    ├── app.js - 路由和 UI 组件
    ├── api.js - API 封装
    └── pages/
        ├── dashboard.js - 系统概览
        ├── conditions.js - 筛选条件
        ├── upload.js - 简历上传
        ├── talents.js - 人才信息
        └── analysis.js - 数据分析
```

### 2.2 现有资源复用

| 资源          | 复用方式                                   |
| ----------- | -------------------------------------- |
| TaskManager | 扩展任务历史查询功能                             |
| WebSocket   | 复用现有连接管理器                              |
| 健康检查        | 扩展 `/health` 端点                        |
| 日志系统        | 读取 JSON 日志文件                           |
| API 响应格式    | 复用 `APIResponse` 和 `PaginatedResponse` |

***

## 三、详细设计方案

### 3.1 系统日志查看模块

#### 3.1.1 功能需求

* 按时间范围筛选（开始时间、结束时间）

* 按日志级别筛选（DEBUG, INFO, WARNING, ERROR, CRITICAL）

* 关键词搜索（消息内容）

* 分页浏览（每页 50/100/200 条）

* 日志导出（JSON/CSV 格式）

#### 3.1.2 后端 API 设计

```python
# src/api/v1/monitor.py

@router.get("/logs", response_model=APIResponse[PaginatedResponse[LogEntry]])
async def get_logs(
    start_time: datetime | None = Query(None, description="开始时间"),
    end_time: datetime | None = Query(None, description="结束时间"),
    level: list[str] | None = Query(None, description="日志级别"),
    keyword: str | None = Query(None, description="关键词"),
    page: int = Query(1, ge=1),
    page_size: int = Query(50, ge=1, le=200),
):
    """查询系统日志。"""
    pass

@router.get("/logs/export")
async def export_logs(
    start_time: datetime | None = None,
    end_time: datetime | None = None,
    level: list[str] | None = None,
    keyword: str | None = None,
    format: str = Query("json", regex="^(json|csv)$"),
):
    """导出日志文件。"""
    pass
```

#### 3.1.3 数据模型

```python
# src/schemas/monitor.py

class LogEntry(BaseModel):
    """日志条目模型。"""
    timestamp: datetime
    level: str
    message: str
    module: str
    function: str
    line: int
    process_id: int
    thread_id: int
    extra: dict[str, Any] | None = None
    exception: dict[str, Any] | None = None

class LogQueryParams(BaseModel):
    """日志查询参数。"""
    start_time: datetime | None = None
    end_time: datetime | None = None
    levels: list[str] | None = None
    keyword: str | None = None
    page: int = 1
    page_size: int = 50
```

#### 3.1.4 日志服务实现

```python
# src/services/log_service.py

class LogService:
    """日志查询服务。"""
    
    def __init__(self, log_dir: Path):
        self.log_dir = log_dir
    
    async def query_logs(
        self,
        start_time: datetime | None,
        end_time: datetime | None,
        levels: list[str] | None,
        keyword: str | None,
        page: int,
        page_size: int,
    ) -> tuple[list[dict], int]:
        """查询日志条目。"""
        # 1. 确定日志文件范围
        # 2. 逐行读取 JSON 日志
        # 3. 应用筛选条件
        # 4. 分页返回结果
        pass
    
    async def export_logs(
        self,
        start_time: datetime | None,
        end_time: datetime | None,
        levels: list[str] | None,
        keyword: str | None,
        format: str,
    ) -> Path:
        """导出日志文件。"""
        pass
```

***

### 3.2 系统健康检查模块

#### 3.2.1 功能需求

* 实时展示服务器资源使用率（CPU、内存、磁盘）

* 数据库连接状态（MySQL、Redis）

* 存储服务状态（MinIO、ChromaDB）

* 可视化图表展示（仪表盘、趋势图）

#### 3.2.2 后端 API 设计

```python
# src/api/v1/monitor.py

@router.get("/health", response_model=APIResponse[SystemHealth])
async def get_system_health():
    """获取系统健康状态。"""
    pass

@router.get("/metrics", response_model=APIResponse[SystemMetrics])
async def get_system_metrics():
    """获取系统资源指标。"""
    pass

@router.get("/metrics/history", response_model=APIResponse[list[MetricPoint]])
async def get_metrics_history(
    duration: int = Query(3600, description="时间范围（秒）"),
):
    """获取历史资源指标。"""
    pass
```

#### 3.2.3 数据模型

```python
# src/schemas/monitor.py

class ServiceStatus(BaseModel):
    """服务状态模型。"""
    name: str
    status: Literal["healthy", "unhealthy", "degraded"]
    latency_ms: float | None = None
    message: str | None = None
    details: dict[str, Any] | None = None

class ResourceUsage(BaseModel):
    """资源使用率模型。"""
    cpu_percent: float
    memory_percent: float
    memory_used_gb: float
    memory_total_gb: float
    disk_percent: float
    disk_used_gb: float
    disk_total_gb: float

class SystemHealth(BaseModel):
    """系统健康状态模型。"""
    status: Literal["healthy", "unhealthy", "degraded"]
    services: list[ServiceStatus]
    resources: ResourceUsage
    uptime_seconds: int
    last_check: datetime

class MetricPoint(BaseModel):
    """指标数据点模型。"""
    timestamp: datetime
    cpu_percent: float
    memory_percent: float
    disk_percent: float
```

#### 3.2.4 指标采集服务

```python
# src/services/metrics_service.py

import psutil

class MetricsService:
    """系统指标采集服务。"""
    
    def __init__(self, redis_client: RedisClient):
        self.redis = redis_client
        self.metrics_key = "system:metrics"
        self.retention_seconds = 3600  # 保留 1 小时
    
    async def collect_metrics(self) -> ResourceUsage:
        """采集当前系统指标。"""
        cpu = psutil.cpu_percent(interval=0.1)
        memory = psutil.virtual_memory()
        disk = psutil.disk_usage('/')
        
        return ResourceUsage(
            cpu_percent=cpu,
            memory_percent=memory.percent,
            memory_used_gb=memory.used / (1024**3),
            memory_total_gb=memory.total / (1024**3),
            disk_percent=disk.percent,
            disk_used_gb=disk.used / (1024**3),
            disk_total_gb=disk.total / (1024**3),
        )
    
    async def store_metrics(self, metrics: ResourceUsage) -> None:
        """存储指标到 Redis。"""
        pass
    
    async def get_metrics_history(
        self, duration: int
    ) -> list[MetricPoint]:
        """获取历史指标。"""
        pass
```

***

### 3.3 后台任务历史记录模块

#### 3.3.1 功能需求

* 展示所有已完成任务（completed, failed, cancelled）

* 任务详情：ID、名称、开始/结束时间、状态、耗时

* 按状态筛选

* 按时间范围筛选

* 分页浏览

#### 3.3.2 后端 API 设计

```python
# src/api/v1/monitor.py

@router.get("/tasks/history", response_model=APIResponse[PaginatedResponse[TaskHistoryEntry]])
async def get_task_history(
    status: list[str] | None = Query(None, description="任务状态"),
    start_time: datetime | None = Query(None, description="开始时间"),
    end_time: datetime | None = Query(None, description="结束时间"),
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
):
    """获取任务历史记录。"""
    pass

@router.get("/tasks/{task_id}", response_model=APIResponse[TaskDetail])
async def get_task_detail(task_id: str):
    """获取任务详情。"""
    pass
```

#### 3.3.3 数据模型

```python
# src/schemas/monitor.py

class TaskHistoryEntry(BaseModel):
    """任务历史条目模型。"""
    id: str
    name: str
    status: str
    created_at: datetime
    started_at: datetime | None
    completed_at: datetime | None
    duration_seconds: float | None
    progress_percent: float
    error: str | None

class TaskDetail(TaskHistoryEntry):
    """任务详情模型。"""
    progress: TaskProgress
    result: dict[str, Any]
    metadata: dict[str, Any]
```

#### 3.3.4 任务服务扩展

```python
# src/services/task_service.py

class TaskService:
    """任务查询服务。"""
    
    def __init__(self, task_manager: TaskManager, redis_client: RedisClient):
        self.task_manager = task_manager
        self.redis = redis_client
    
    async def get_history(
        self,
        status: list[str] | None,
        start_time: datetime | None,
        end_time: datetime | None,
        page: int,
        page_size: int,
    ) -> tuple[list[TaskInfo], int]:
        """获取任务历史记录。"""
        # 从 Redis 扫描所有任务键
        pass
```

***

### 3.4 正在进行的任务监控模块

#### 3.4.1 功能需求

* 实时显示运行中任务列表

* 任务进度条展示

* 资源占用估算

* 任务取消操作

* WebSocket 实时更新

#### 3.4.2 后端 API 设计

```python
# src/api/v1/monitor.py

@router.get("/tasks/running", response_model=APIResponse[list[RunningTask]])
async def get_running_tasks():
    """获取正在运行的任务。"""
    pass

@router.post("/tasks/{task_id}/cancel", response_model=APIResponse[None])
async def cancel_task(task_id: str):
    """取消任务。"""
    pass
```

#### 3.4.3 数据模型

```python
# src/schemas/monitor.py

class RunningTask(BaseModel):
    """运行中任务模型。"""
    id: str
    name: str
    status: str
    progress: TaskProgress
    started_at: datetime
    elapsed_seconds: float
    estimated_remaining_seconds: float | None
```

***

## 四、前端实现方案

### 4.1 页面结构

```
frontend-new/js/pages/monitor.js
├── MonitorPage 主模块
│   ├── render() - 渲染页面骨架
│   ├── initEvents() - 初始化事件
│   └── 子模块
│       ├── LogViewer - 日志查看器
│       ├── HealthDashboard - 健康仪表盘
│       ├── TaskHistory - 任务历史
│       └── RunningTasks - 运行中任务
```

### 4.2 页面布局设计

```
┌─────────────────────────────────────────────────────────────┐
│  系统监控                                                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐  │
│  │ CPU 使用率      │  │ 内存使用率      │  │ 磁盘使用率   │  │
│  │    [仪表盘]     │  │    [仪表盘]     │  │   [仪表盘]   │  │
│  │     45%        │  │     62%         │  │     38%     │  │
│  └─────────────────┘  └─────────────────┘  └─────────────┘  │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 服务状态                                                  │ │
│  │  ● MySQL (健康)  ● Redis (健康)  ● MinIO (健康)          │ │
│  │  ● ChromaDB (健康)                                       │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  [日志查看] [任务历史] [运行中任务]                           │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                                                          │ │
│  │              Tab 内容区域                                 │ │
│  │                                                          │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 组件设计

#### 4.3.1 日志查看器组件

```javascript
const LogViewer = {
    state: {
        logs: [],
        filters: {
            startTime: null,
            endTime: null,
            levels: [],
            keyword: '',
        },
        pagination: { page: 1, pageSize: 50, total: 0 },
    },
    
    render() {
        return `
            <div class="log-viewer">
                ${this.renderFilters()}
                ${this.renderLogList()}
                ${this.renderPagination()}
            </div>
        `;
    },
    
    renderFilters() {
        // 时间选择器、级别筛选、关键词搜索
    },
    
    renderLogList() {
        // 日志列表表格
    },
    
    async loadLogs() {
        // 调用 API 加载日志
    },
    
    exportLogs(format) {
        // 导出日志
    },
};
```

#### 4.3.2 健康仪表盘组件

```javascript
const HealthDashboard = {
    charts: {},
    
    render() {
        return `
            <div class="health-dashboard">
                ${this.renderResourceGauges()}
                ${this.renderServiceStatus()}
                ${this.renderMetricsChart()}
            </div>
        `;
    },
    
    renderResourceGauges() {
        // ECharts 仪表盘
    },
    
    renderServiceStatus() {
        // 服务状态列表
    },
    
    renderMetricsChart() {
        // 资源使用趋势图
    },
    
    async refreshHealth() {
        // 刷新健康状态
    },
    
    initCharts() {
        // 初始化 ECharts 实例
    },
};
```

#### 4.3.3 任务历史组件

```javascript
const TaskHistory = {
    state: {
        tasks: [],
        filters: { status: [], startTime: null, endTime: null },
        pagination: { page: 1, pageSize: 20, total: 0 },
    },
    
    render() {
        return `
            <div class="task-history">
                ${this.renderFilters()}
                ${this.renderTaskList()}
                ${this.renderPagination()}
            </div>
        `;
    },
    
    async loadTasks() {
        // 加载任务历史
    },
    
    showTaskDetail(taskId) {
        // 显示任务详情模态框
    },
};
```

#### 4.3.4 运行中任务组件

```javascript
const RunningTasks = {
    ws: null,
    tasks: [],
    
    render() {
        return `
            <div class="running-tasks">
                ${this.renderTaskList()}
            </div>
        `;
    },
    
    connectWebSocket() {
        // 连接 WebSocket 接收实时更新
    },
    
    handleTaskUpdate(data) {
        // 处理任务更新
    },
    
    async cancelTask(taskId) {
        // 取消任务
    },
};
```

### 4.4 样式设计

```css
/* 监控页面专用样式 */

/* 资源仪表盘 */
.resource-gauges {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 24px;
}

.gauge-card {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    padding: 20px;
    text-align: center;
}

.gauge-chart {
    height: 160px;
}

.gauge-value {
    font-size: 28px;
    font-weight: 600;
    color: var(--text-primary);
}

/* 服务状态 */
.service-status-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
}

.service-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
}

.service-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
}

.service-indicator.healthy { background: var(--success-color); }
.service-indicator.unhealthy { background: var(--danger-color); }
.service-indicator.degraded { background: var(--warning-color); }

/* 日志查看器 */
.log-viewer {
    /* 日志样式 */
}

.log-entry {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border-color);
    font-family: 'Consolas', monospace;
    font-size: 13px;
}

.log-entry.level-error { background: var(--danger-bg); }
.log-entry.level-warning { background: var(--warning-bg); }

/* 任务卡片 */
.task-card {
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-color);
    padding: 16px;
    margin-bottom: 12px;
}

.task-progress-bar {
    height: 8px;
    background: var(--bg-tertiary);
    border-radius: 4px;
    overflow: hidden;
}

.task-progress-fill {
    height: 100%;
    background: var(--primary-color);
    transition: width 0.3s ease;
}
```

***

## 五、后端实现方案

### 5.1 文件结构

```
src/
├── api/v1/
│   └── monitor.py          # 监控 API 端点
├── schemas/
│   └── monitor.py          # 监控相关数据模型
├── services/
│   ├── log_service.py      # 日志查询服务
│   ├── metrics_service.py  # 指标采集服务
│   └── task_service.py     # 任务查询服务
└── core/
    └── tasks.py            # 扩展 TaskManager
```

### 5.2 API 路由注册

```python
# src/api/main.py

from src.api.v1.monitor import router as monitor_router

app.include_router(monitor_router, prefix="/api/v1")
```

### 5.3 依赖添加

```toml
# pyproject.toml

[project.dependencies]
psutil = ">=6.0.0"  # 系统指标采集
```

***

## 六、实施步骤

### 阶段一：后端 API 开发（预计 4 个任务）

1. **创建监控数据模型** (`src/schemas/monitor.py`)

   * LogEntry, LogQueryParams

   * ServiceStatus, ResourceUsage, SystemHealth

   * TaskHistoryEntry, TaskDetail, RunningTask

2. **实现日志查询服务** (`src/services/log_service.py`)

   * 读取 JSON 日志文件

   * 筛选和分页逻辑

   * 导出功能

3. **实现指标采集服务** (`src/services/metrics_service.py`)

   * psutil 采集 CPU/内存/磁盘

   * Redis 存储历史指标

   * 定时采集任务

4. **实现监控 API 端点** (`src/api/v1/monitor.py`)

   * 日志查询和导出

   * 健康检查和指标

   * 任务历史和运行中任务

### 阶段二：前端页面开发（预计 3 个任务）

1. **创建监控页面骨架** (`frontend-new/js/pages/monitor.js`)

   * 页面布局

   * Tab 切换

   * 路由集成

2. **实现日志查看器组件**

   * 筛选表单

   * 日志列表

   * 导出功能

3. **实现健康仪表盘和任务监控**

   * ECharts 仪表盘

   * 服务状态展示

   * 任务列表和操作

### 阶段三：集成测试（预计 2 个任务）

1. **后端单元测试**

   * 日志服务测试

   * 指标服务测试

   * API 端点测试

2. **前端功能测试**

   * 页面渲染测试

   * API 调用测试

   * WebSocket 连接测试

***

## 七、风险与对策

| 风险              | 影响 | 对策               |
| --------------- | -- | ---------------- |
| 日志文件过大导致读取慢     | 高  | 实现流式读取，限制查询范围    |
| 频繁采集指标影响性能      | 中  | 采集间隔不低于 5 秒，异步处理 |
| WebSocket 连接不稳定 | 中  | 实现自动重连机制         |
| 前端图表渲染性能        | 低  | 限制历史数据点数量        |

***

## 八、验收标准

### 8.1 功能验收

* [ ] 日志查看器支持时间、级别、关键词筛选

* [ ] 日志查看器支持分页和导出

* [ ] 健康仪表盘实时展示 CPU/内存/磁盘使用率

* [ ] 服务状态正确显示各组件健康状态

* [ ] 任务历史正确展示已完成任务

* [ ] 运行中任务实时更新进度

* [ ] 任务取消功能正常工作

### 8.2 性能验收

* [ ] 日志查询响应时间 < 2 秒

* [ ] 健康检查响应时间 < 500ms

* [ ] 页面首次加载时间 < 3 秒

* [ ] WebSocket 消息延迟 < 1 秒

### 8.3 代码质量

* [ ] 后端测试覆盖率 ≥ 95%

* [ ] Ruff 格式化通过

* [ ] Basedpyright 类型检查通过

* [ ] 中文注释完整

***

## 九、附录

### A. API 端点汇总

| 端点                                  | 方法   | 描述     |
| ----------------------------------- | ---- | ------ |
| `/api/v1/monitor/logs`              | GET  | 查询日志   |
| `/api/v1/monitor/logs/export`       | GET  | 导出日志   |
| `/api/v1/monitor/health`            | GET  | 系统健康状态 |
| `/api/v1/monitor/metrics`           | GET  | 当前资源指标 |
| `/api/v1/monitor/metrics/history`   | GET  | 历史资源指标 |
| `/api/v1/monitor/tasks/history`     | GET  | 任务历史   |
| `/api/v1/monitor/tasks/running`     | GET  | 运行中任务  |
| `/api/v1/monitor/tasks/{id}`        | GET  | 任务详情   |
| `/api/v1/monitor/tasks/{id}/cancel` | POST | 取消任务   |

### B. 前端文件清单

| 文件                                 | 描述                        |
| ---------------------------------- | ------------------------- |
| `frontend-new/js/pages/monitor.js` | 监控页面主模块                   |
| `frontend-new/css/monitor.css`     | 监控页面样式（可选，可合并到 style.css） |

### C. 后端文件清单

| 文件                                | 描述        |
| --------------------------------- | --------- |
| `src/api/v1/monitor.py`           | 监控 API 端点 |
| `src/schemas/monitor.py`          | 监控数据模型    |
| `src/services/log_service.py`     | 日志查询服务    |
| `src/services/metrics_service.py` | 指标采集服务    |
| `src/services/task_service.py`    | 任务查询服务    |

