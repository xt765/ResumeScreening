# 系统监控页面重构计划

## 一、需求概述

### 1.1 目标
1. **彻底移除任务历史和运行中任务功能**
2. **全面重新设计日志查看功能**，确保用户交互良好

### 1.2 日志格式分析

#### 普通日志格式 (`app_*.jsonl`)
```json
{
  "timestamp": "2026-02-23T00:09:46.474713+08:00",
  "level": "INFO",
  "message": "日志系统初始化完成",
  "module": "logger",
  "function": "setup_logger",
  "line": 186,
  "process_id": 17292,
  "thread_id": 27804,
  "extra": {"log_dir": "logs"}
}
```

#### 错误日志格式 (`error_*.jsonl`)
```json
{
  "timestamp": "2026-02-23T01:31:26.467279+08:00",
  "level": "ERROR",
  "message": "查询向量化失败: Error code: 400 - ...",
  "module": "embedding",
  "function": "embed_query",
  "line": 152,
  "process_id": 7108,
  "thread_id": 6380,
  "exception": {
    "type": "BadRequestError",
    "value": null,
    "traceback": null
  }
}
```

#### 日志级别
| 级别 | 颜色 | 说明 |
|------|------|------|
| DEBUG | 灰色 | 调试信息 |
| INFO | 蓝色 | 普通信息 |
| SUCCESS | 绿色 | 成功操作 |
| WARNING | 橙色 | 警告信息 |
| ERROR | 红色 | 错误信息 |
| CRITICAL | 深红 | 严重错误 |

---

## 二、需要移除的功能

### 2.1 后端 API 端点（删除）
| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/v1/monitor/tasks/history` | GET | 任务历史查询 |
| `/api/v1/monitor/tasks/running` | GET | 运行中任务查询 |
| `/api/v1/monitor/tasks/{task_id}` | GET | 任务详情 |
| `/api/v1/monitor/tasks/{task_id}/cancel` | POST | 取消任务 |

### 2.2 后端数据模型（删除）
- `TaskHistoryEntry`
- `TaskDetail`
- `RunningTask`
- `TaskProgressInfo`

### 2.3 前端功能（删除）
- 任务历史 Tab
- 运行中任务 Tab
- WebSocket 连接（用于任务进度推送）
- 任务取消功能
- 相关样式

---

## 三、日志查看重新设计

### 3.1 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│  系统监控                                                     │
│  实时监控系统运行状态和资源使用情况                              │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 资源监控                              [立即检查] 按钮    │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐              │ │
│  │  │ CPU 12%  │  │ 内存 79% │  │ 磁盘 13% │              │ │
│  │  │ [仪表盘] │  │ [仪表盘] │  │ [仪表盘] │              │ │
│  │  └──────────┘  └──────────┘  └──────────┘              │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 服务状态                                                 │ │
│  │  ● MySQL (健康)  ● Redis (健康)  ● MinIO (健康)         │ │
│  │  ● ChromaDB (健康)                                       │ │
│  └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│  系统日志                                                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 筛选条件                                                 │ │
│  │  [最近5分钟 ▼] [全部级别 ▼] [搜索关键词...] [搜索]       │ │
│  │  [导出 ▼]                              [⬇️ 最新在前]    │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 10:23:45 [INFO] logger - 日志系统初始化完成              │ │
│  │ 10:23:45 [INFO] main - 应用启动中...                     │ │
│  │ 10:23:46 [SUCCESS] __init__ - 数据库连接初始化完成       │ │
│  │ 10:24:12 [ERROR] embedding - 查询向量化失败        [展开]│ │
│  │ 10:25:30 [WARNING] websocket - 连接超时                  │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                              │
│  [上一页] 1 / 10 [下一页]                    共 500 条记录   │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 筛选功能设计

#### 时间范围快捷选项
| 选项 | 说明 |
|------|------|
| 最近 5 分钟 | 当前时间往前推 5 分钟 |
| 最近 30 分钟 | 当前时间往前推 30 分钟 |
| 最近 3 小时 | 当前时间往前推 3 小时 |
| 今天 | 当天 00:00 至今 |
| 昨天 | 昨天 00:00 - 23:59 |
| 最近 7 天 | 7 天前 00:00 至今 |
| 最近 30 天 | 30 天前 00:00 至今 |
| 自定义 | 弹出日期时间选择器 |

#### 时间排序按钮
- **默认排序**: 逆序（最新日志在前）
- **切换按钮**: 点击可切换正序/逆序
- **图标显示**: 
  - 逆序 ⬇️ (最新在前)
  - 正序 ⬆️ (最早在前)
- **状态记忆**: 切换后保持当前排序状态

#### 日志级别筛选
- 下拉多选框
- 默认显示全部级别
- 支持多选：DEBUG, INFO, SUCCESS, WARNING, ERROR, CRITICAL

#### 关键词搜索
- 搜索日志消息内容
- 实时搜索（输入防抖 300ms）
- 支持正则表达式（可选）

### 3.3 日志列表设计

#### 日志条目显示
```
┌─────────────────────────────────────────────────────────────┐
│ 10:23:45 [INFO] logger.setup_logger:186                     │
│ 日志系统初始化完成                                           │
│                                                             │
│ [展开详情] 显示 extra 字段                                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│ 10:24:12 [ERROR] embedding.embed_query:152                  │
│ 查询向量化失败: Error code: 400 - InvalidParameter          │
│                                                             │
│ [展开详情] 显示 exception 字段                               │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 异常类型: BadRequestError                                │ │
│ │ 异常值: null                                             │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 日志级别样式
| 级别 | 背景色 | 文字色 | 图标 |
|------|--------|--------|------|
| DEBUG | 灰色 | 灰色 | 🔍 |
| INFO | 蓝色背景 | 蓝色 | ℹ️ |
| SUCCESS | 绿色背景 | 绿色 | ✓ |
| WARNING | 橙色背景 | 橙色 | ⚠ |
| ERROR | 红色背景 | 红色 | ✗ |
| CRITICAL | 深红背景 | 白色 | ‼ |

### 3.4 交互设计

#### 搜索交互
1. 点击"搜索"按钮或按 Enter 键触发搜索
2. 搜索时显示加载状态
3. 搜索结果为空时显示友好提示

#### 日志详情展开
1. 点击日志条目展开详情
2. 显示完整的 extra 和 exception 信息
3. 支持复制日志内容

#### 导出功能
1. 下拉菜单选择导出格式（JSON/CSV）
2. 导出当前筛选条件下的所有日志
3. 显示导出进度

### 3.5 性能优化

1. **虚拟滚动**：当日志数量超过 100 条时启用虚拟滚动
2. **分页加载**：每页 50 条，支持无限滚动加载
3. **防抖搜索**：关键词输入防抖 300ms
4. **缓存机制**：缓存已加载的日志页面

---

## 四、实施步骤

### 阶段一：后端清理（2 个任务）

#### 任务 1：移除任务相关 API 端点
**文件**: `src/api/v1/monitor.py`
- 删除 `/tasks/history` 端点
- 删除 `/tasks/running` 端点
- 删除 `/tasks/{task_id}` 端点
- 删除 `/tasks/{task_id}/cancel` 端点
- 删除相关的辅助函数

#### 任务 2：清理数据模型
**文件**: `src/schemas/monitor.py`
- 删除 `TaskHistoryEntry` 类
- 删除 `TaskDetail` 类
- 删除 `RunningTask` 类
- 删除 `TaskProgressInfo` 类

### 阶段二：前端重构（3 个任务）

#### 任务 3：移除任务相关前端代码
**文件**: `frontend-new/js/pages/monitor.js`
- 删除 `renderHistoryTab()` 方法
- 删除 `renderRunningTab()` 方法
- 删除 `loadTaskHistory()` 方法
- 删除 `loadRunningTasks()` 方法
- 删除 `cancelTask()` 方法
- 删除 `connectWebSocket()` 方法
- 删除 `handleWebSocketMessage()` 方法
- 删除 `updateTaskProgress()` 方法
- 删除 WebSocket 相关代码
- 移除任务相关的 Tab

#### 任务 4：重新设计日志查看界面
**文件**: `frontend-new/js/pages/monitor.js`
- 重新设计 `renderLogsTab()` 方法
- 实现时间范围快捷选择
- 实现日志级别多选筛选
- 实现关键词搜索（防抖）
- 重新设计日志列表显示
- 实现日志详情展开功能
- 优化分页组件

#### 任务 5：优化样式和交互
**文件**: `frontend-new/js/pages/monitor.js`（样式部分）
- 优化日志级别颜色和图标
- 添加日志详情展开动画
- 优化加载状态显示
- 优化空状态提示
- 添加响应式布局支持

### 阶段三：测试验证（1 个任务）

#### 任务 6：功能测试
- 测试日志查询功能
- 测试筛选功能（时间、级别、关键词）
- 测试导出功能
- 测试分页功能
- 测试日志详情展开
- 验证任务相关功能已完全移除

---

## 五、文件修改清单

### 后端文件
| 文件 | 操作 | 说明 |
|------|------|------|
| `src/api/v1/monitor.py` | 修改 | 移除任务相关端点 |
| `src/schemas/monitor.py` | 修改 | 移除任务相关模型 |

### 前端文件
| 文件 | 操作 | 说明 |
|------|------|------|
| `frontend-new/js/pages/monitor.js` | 重构 | 移除任务功能，重新设计日志查看 |

---

## 六、验收标准

### 功能验收
- [ ] 任务历史 Tab 已移除
- [ ] 运行中任务 Tab 已移除
- [ ] WebSocket 连接已移除
- [ ] 日志查看功能正常工作
- [ ] 时间范围筛选正常工作（包含 5 分钟、30 分钟、3 小时选项）
- [ ] 时间排序切换正常工作（正序/逆序）
- [ ] 日志级别筛选正常工作
- [ ] 关键词搜索正常工作
- [ ] 日志详情展开正常工作
- [ ] 导出功能正常工作
- [ ] 分页功能正常工作

### 代码质量
- [ ] 后端无未使用的导入
- [ ] 前端无未使用的代码
- [ ] Ruff 格式化通过
- [ ] Basedpyright 类型检查通过
- [ ] 中文注释完整

### 用户体验
- [ ] 日志级别颜色区分明显
- [ ] 筛选操作流畅
- [ ] 加载状态反馈清晰
- [ ] 空状态提示友好
- [ ] 响应式布局正常
