# 数据分析页面问题修复计划

## 问题概述

数据分析页面 (`#/analysis`) 显示了人才信息页面的内容，页面内容错乱。

## 问题分析

### 问题 1：前端页面切换竞态问题

**现象**：访问 `http://localhost:3000/#/analysis` 时，页面显示的是人才信息页面的内容。

**根本原因**：`TalentsPage.updateContent()` 异步更新问题

**问题代码** - [frontend-new/js/pages/talents.js:53-59](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/talents.js#L53-L59)

```javascript
updateContent() {
    const container = document.getElementById('pageContainer');
    if (container) {
        container.innerHTML = this.renderContent();  // 无条件覆盖！
        this.initEvents();
    }
}
```

**问题链路**：

```
1. 用户访问 #/talents
2. TalentsPage.render() 调用，启动异步 loadDataAsync()
3. 用户快速切换到 #/analysis
4. AppState.currentPage = 'analysis'
5. AnalysisPage.render() 渲染数据分析页面
6. TalentsPage.loadDataAsync() 异步完成
7. TalentsPage.updateContent() 覆盖 pageContainer ← 问题发生！
```

### 问题 2：RAG 智能查询向量维度不匹配

**现象**：执行 RAG 查询时报错 `Collection expecting embedding with dimension of 384, got 1024`

**根本原因**：存储和查询使用不同维度的向量

| 组件                     | 向量维度   |
| ---------------------- | ------ |
| ChromaDB 存储（默认函数）      | 384 维  |
| DashScope Embedding 查询 | 1024 维 |

***

## 修复方案

### 修复 1：前端页面切换竞态问题

**文件**: [frontend-new/js/pages/talents.js](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/talents.js)

**修改内容**：在 `updateContent()` 中检查当前页面

```javascript
updateContent() {
    // 检查当前页面是否还是 talents
    if (window.AppState?.currentPage !== 'talents') {
        console.log('页面已切换，跳过更新');
        return;
    }
    
    const container = document.getElementById('pageContainer');
    if (container) {
        container.innerHTML = this.renderContent();
        this.initEvents();
    }
}
```

### 修复 2：RAG 向量维度问题

**文件**: [src/workflows/store\_node.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/workflows/store_node.py)

**修改内容**：

1. 将 `_store_to_chromadb` 改为异步函数
2. 使用 DashScope Embedding 生成向量
3. 传递 `embeddings` 参数

```python
async def _store_to_chromadb(
    talent_id: str,
    resume_text: str,
    candidate_info: dict[str, Any],
) -> bool:
    """存储简历向量到 ChromaDB。"""
    if not resume_text:
        logger.warning("简历文本为空，跳过向量存储")
        return False

    try:
        from src.utils.embedding import get_embedding_service
        
        embedding_service = get_embedding_service()
        embeddings = await embedding_service.embed_texts([resume_text])
        
        if not embeddings:
            logger.warning("向量生成失败，跳过存储")
            return False

        # 构建元数据...
        metadata = {...}

        # 添加到 ChromaDB（带向量）
        chroma_client.add_documents(
            ids=[talent_id],
            documents=[resume_text],
            metadatas=[metadata],
            embeddings=embeddings,  # 使用 DashScope 生成的向量
        )

        logger.info(f"向量存储成功: talent_id={talent_id}")
        return True
    except Exception as e:
        ...
```

**同时修改** **`store_node`** **函数**：

```python
# 4. 存储向量到 ChromaDB
if state.text_content:
    await _store_to_chromadb(  # 改为 await
        talent_id,
        state.text_content,
        state.candidate_info,
    )
```

### 修复 3：清空现有 ChromaDB 数据

由于现有数据向量维度不兼容，需要清空：

```bash
# 删除 ChromaDB 数据目录
rm -rf data/chroma/*
```

或重新上传简历生成新向量。

***

## 验证步骤

### 1. 验证前端页面切换

1. 刷新页面，直接访问 `#/analysis`
2. 确认显示数据分析页面内容（RAG 查询区域）
3. 切换到 `#/talents`，等待数据加载
4. 快速切换到 `#/analysis`
5. 确认页面仍然显示数据分析内容

### 2. 验证 RAG 查询

1. 上传一份新简历
2. 在数据分析页面执行 RAG 查询
3. 确认返回正常结果

***

## 文件修改清单

| 文件                                                                                                                     | 修改内容                   |
| ---------------------------------------------------------------------------------------------------------------------- | ---------------------- |
| [frontend-new/js/pages/talents.js](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/talents.js) | 添加页面切换检查               |
| [src/workflows/store\_node.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/workflows/store_node.py)          | 使用 DashScope Embedding |

***

## 时间估算

| 任务             | 预计时间      |
| -------------- | --------- |
| 修复前端竞态问题       | 5 分钟      |
| 修复后端向量问题       | 15 分钟     |
| 清空 ChromaDB 数据 | 5 分钟      |
| 测试验证           | 10 分钟     |
| **总计**         | **35 分钟** |

