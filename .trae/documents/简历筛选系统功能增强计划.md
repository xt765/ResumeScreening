# 简历筛选系统功能增强计划

## 问题概述

| 序号 | 问题 | 当前状态 |
|------|------|----------|
| 1 | 简历无法批量上传 | 仅支持单文件上传 |
| 2 | 不支持同时进行多个筛选 | 每次只能选择一个筛选条件 |
| 3 | 不支持根据已保存人才信息做筛选 | 后端有筛选API，前端未完整实现 |
| 4 | 不支持上传简历时做去重 | 无去重逻辑 |
| 5 | 头像图片显示不出来 | MinIO URL 可能无法访问 |
| 6 | 联系电话和邮箱加密看不到 | 解密逻辑存在问题 |

---

## 详细分析与解决方案

### 1. 批量上传简历

**问题分析**：
- 前端 `upload.js` 只处理单个文件
- 后端 `talents.py` 接口只接收单个 `UploadFile`

**解决方案**：
1. 后端新增批量上传接口 `POST /api/v1/talents/batch-upload`
   - 接收 `List[UploadFile]` 文件列表
   - 可选指定筛选条件 ID
   - 返回批量处理结果

2. 前端修改上传组件
   - 添加 `multiple` 属性支持多选
   - 显示上传进度和结果列表

**涉及文件**：
- `src/api/v1/talents.py` - 新增批量上传接口
- `frontend-new/js/pages/upload.js` - 修改上传逻辑
- `frontend-new/js/api.js` - 添加批量上传 API 调用

---

### 2. 支持多个筛选条件（支持与或非逻辑）

**问题分析**：
- 当前 `condition_id` 只支持单个
- 筛选逻辑在 `filter_node.py` 中只处理单个条件

**解决方案**：
1. 后端设计筛选条件组合模型
   ```python
   class ConditionGroup(BaseModel):
       logic: Literal["AND", "OR"]  # 组内逻辑
       condition_ids: list[str]     # 条件ID列表
   
   class FilterRequest(BaseModel):
       groups: list[ConditionGroup]  # 多个条件组
       group_logic: Literal["AND", "OR"]  # 组间逻辑
       exclude_condition_ids: list[str]  # 排除条件（NOT逻辑）
   ```

2. 筛选逻辑实现
   - **AND 逻辑**：所有条件都必须满足
   - **OR 逻辑**：任一条件满足即可
   - **NOT 逻辑**：排除满足该条件的人才
   - 支持嵌套组合：(条件A AND 条件B) OR (条件C AND NOT 条件D)

3. 前端筛选条件构建器
   - 可视化条件组合界面
   - 支持添加条件组
   - 每个组内选择 AND/OR 逻辑
   - 支持排除条件（NOT）

**界面设计**：
```
┌─────────────────────────────────────────────────┐
│ 筛选条件构建器                                    │
├─────────────────────────────────────────────────┤
│ 条件组 1 (AND)                    [+ 添加条件]   │
│   ☑ 高级Python开发工程师筛选条件                 │
│   ☑ 前端开发工程师筛选条件                       │
│                                                  │
│ 条件组 2 (OR)                     [+ 添加条件]   │
│   ☑ 数据分析师筛选条件                           │
│                                                  │
│ 组间逻辑: ○ AND  ● OR                            │
│                                                  │
│ 排除条件 (NOT):                   [+ 添加排除]   │
│   ☑ 实习生筛选条件                               │
│                                                  │
│ [应用筛选]                                       │
└─────────────────────────────────────────────────┘
```

**涉及文件**：
- `src/api/v1/talents.py` - 新增复杂筛选接口
- `src/workflows/filter_node.py` - 重构为支持组合逻辑
- `src/models/schemas.py` - 新增筛选请求模型
- `frontend-new/js/pages/upload.js` - 条件构建器组件
- `frontend-new/css/style.css` - 条件构建器样式

---

### 2.1 后台筛选任务与实时进度显示

**问题分析**：
- 当前筛选是同步阻塞的
- 无法同时进行多个筛选任务
- 用户无法看到筛选进度

**解决方案**：

1. **后台任务队列**
   - 使用 `asyncio.create_task` 创建后台任务
   - 或集成 Celery 任务队列（可选）
   - 每个筛选任务分配唯一 `task_id`

2. **任务状态存储**
   ```python
   class TaskStatus(BaseModel):
       task_id: str
       status: Literal["pending", "running", "completed", "failed"]
       progress: int  # 0-100
       current_step: str  # 当前处理步骤
       total_files: int
       processed_files: int
       result: dict | None
       error: str | None
       created_at: datetime
       updated_at: datetime
   ```
   - 使用 Redis 存储任务状态
   - 支持任务取消、暂停、恢复

3. **实时进度推送（WebSocket）**
   ```python
   # 后端 WebSocket 接口
   @router.websocket("/ws/tasks/{task_id}")
   async def task_progress_websocket(websocket: WebSocket, task_id: str):
       await websocket.accept()
       while True:
           status = await get_task_status(task_id)
           await websocket.send_json(status.dict())
           if status.status in ["completed", "failed"]:
               break
           await asyncio.sleep(0.5)
   ```

4. **前端进度显示组件**
   ```
   ┌─────────────────────────────────────────────────┐
   │ 筛选任务列表                                     │
   ├─────────────────────────────────────────────────┤
   │ 任务 #1: 批量筛选 (10个文件)                     │
   │ ████████████░░░░░░░░ 60%  6/10 处理中...        │
   │ 当前: 解析简历_张三.pdf                         │
   │ [取消任务]                                       │
   │                                                  │
   │ 任务 #2: 高级Python工程师筛选                    │
   │ ████████████████████ 100%  完成 ✓               │
   │ 结果: 通过 3 人，不通过 2 人  [查看详情]         │
   │                                                  │
   │ 任务 #3: 数据分析师筛选                          │
   │ ░░░░░░░░░░░░░░░░░░░░ 等待中...                  │
   │ [开始] [取消]                                    │
   └─────────────────────────────────────────────────┘
   ```

5. **批量筛选 API 设计**
   ```python
   # 创建批量筛选任务
   POST /api/v1/tasks/batch-screen
   {
       "file_ids": ["uuid1", "uuid2", ...],  # 已上传文件ID
       "filter_config": {
           "groups": [...],
           "group_logic": "AND",
           "exclude_condition_ids": [...]
       }
   }
   Response: {"task_id": "xxx", "status": "pending"}
   
   # 查询任务状态
   GET /api/v1/tasks/{task_id}
   
   # 取消任务
   DELETE /api/v1/tasks/{task_id}
   
   # 获取所有任务列表
   GET /api/v1/tasks
   ```

**涉及文件**：
- `src/api/v1/tasks.py` - 新增任务管理接口（新建）
- `src/services/task_manager.py` - 任务管理服务（新建）
- `src/services/progress_tracker.py` - 进度追踪服务（新建）
- `src/api/v1/websocket.py` - WebSocket 接口（新建）
- `frontend-new/js/services/websocket.js` - WebSocket 客户端（新建）
- `frontend-new/js/components/task-progress.js` - 进度组件（新建）
- `frontend-new/js/pages/tasks.js` - 任务列表页面（新建）

---

### 3. 根据已保存人才信息筛选

**问题分析**：
- 后端 `list_talents` 已支持 `name`, `major`, `school`, `screening_status` 筛选
- 前端人才查询页面筛选功能不完整

**解决方案**：
1. 后端扩展筛选条件
   - 添加 `education_level` 学历筛选
   - 添加 `work_years_min/max` 工作年限筛选
   - 添加 `skills` 技能筛选（数组匹配）

2. 前端完善筛选表单
   - 添加学历下拉选择
   - 添加工作年限范围
   - 添加技能标签选择

**涉及文件**：
- `src/api/v1/talents.py` - 扩展筛选参数
- `frontend-new/js/pages/talents.js` - 完善筛选表单

---

### 4. 上传简历去重

**问题分析**：
- 当前无任何去重逻辑
- 可能导致同一简历重复上传

**解决方案**：
1. 后端添加去重检查
   - 基于简历文件内容哈希（MD5/SHA256）
   - 基于候选人姓名+电话组合
   - 返回重复提示或跳过处理

2. 数据库添加唯一约束
   - 添加 `content_hash` 字段
   - 添加唯一索引

**涉及文件**：
- `src/models/talent.py` - 添加 `content_hash` 字段
- `src/api/v1/talents.py` - 添加去重检查逻辑
- `src/workflows/store_node.py` - 计算并存储哈希

---

### 5. 头像图片显示

**问题分析**：
- MinIO URL 格式为 `http://{endpoint}/{bucket}/talents/{id}/photo_1.png`
- 可能的问题：
  1. MinIO 服务不可访问
  2. 存储桶权限问题
  3. 前端跨域问题

**解决方案**：
1. 后端添加图片代理接口
   - `GET /api/v1/talents/{id}/photo`
   - 从 MinIO 读取图片并返回

2. 或配置 MinIO 公开访问
   - 设置存储桶策略为公开读取

**涉及文件**：
- `src/api/v1/talents.py` - 新增图片代理接口
- `src/storage/minio_client.py` - 添加获取图片方法
- `frontend-new/js/pages/talents.js` - 修改图片 URL

---

### 6. 联系电话和邮箱解密显示

**问题分析**：
- `store_node.py` 中有加密逻辑
- `talents.py` 中有解密逻辑 `_decrypt_sensitive_fields`
- 可能的问题：
  1. 加密和解密使用不同的密钥派生方式
  2. 密钥配置问题

**解决方案**：
1. 统一加解密逻辑
   - 确保使用相同的 `encrypt_data` 和 `decrypt_data`
   - 检查 `store_node.py` 中的加密调用

2. 添加解密状态标识
   - 返回字段标识是否解密成功

**涉及文件**：
- `src/workflows/store_node.py` - 统一使用 `security.encrypt_data`
- `src/api/v1/talents.py` - 完善解密逻辑

---

## 实施计划

### 阶段一：核心功能（优先级高）
1. 修复电话/邮箱解密问题
2. 修复头像图片显示
3. 添加简历去重功能

### 阶段二：功能增强
4. 实现批量上传
5. 扩展人才筛选条件

### 阶段三：高级功能
6. 支持多筛选条件

---

## 预估工作量

| 任务 | 预估时间 |
|------|----------|
| 修复解密问题 | 30 分钟 |
| 修复头像显示 | 30 分钟 |
| 添加去重功能 | 1 小时 |
| 批量上传 | 2 小时 |
| 扩展筛选条件 | 1 小时 |
| 多筛选条件（支持与或非） | 3 小时 |
| 后台任务与实时进度 | 4 小时 |

**总计**：约 12 小时
