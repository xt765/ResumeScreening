# 问题排查与修复计划

## 问题概述

用户报告了三个问题：
1. 上传任务的处理进度没有正确更新，刷新页面后进度不再显示
2. 人才信息删除成功后，页面没有自动更新
3. 人才信息删除后，简历上传的去重机制导致简历无法再次上传解析

---

## 问题一：上传进度刷新后丢失

### 根因分析

| 层级 | 问题 | 位置 |
|------|------|------|
| 前端 | `currentTaskId` 存储在 JavaScript 内存变量中，页面刷新后丢失 | [upload.js:28](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/upload.js#L28) |
| 前端 | 页面加载时没有恢复未完成任务的状态 | [upload.js:606-632](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/upload.js#L606-L632) |
| 后端 | 任务存储在内存字典中，服务重启后丢失 | [tasks.py:119](file:///d:/Documents/CodeProjects/ResumeScreening/src/core/tasks.py#L119) |

### 修复方案

#### 前端修改 ([upload.js](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/upload.js))

1. **使用 `localStorage` 持久化任务 ID**
   - 在 `submitScreening()` 成功后保存 `taskId` 到 `localStorage`
   - 在 `clearAllFiles()` 中清除 `localStorage` 中的任务 ID

2. **页面加载时恢复任务状态**
   - 在 `initEvents()` 中检查 `localStorage` 是否有未完成的任务
   - 如果有，调用后端 API 获取任务状态
   - 如果任务仍在进行中，显示进度容器并订阅 WebSocket 更新

3. **新增方法**
   - `saveTaskId(taskId)`: 保存任务 ID 到 localStorage
   - `clearTaskId()`: 清除 localStorage 中的任务 ID
   - `restoreTaskProgress()`: 恢复任务进度显示

#### 后端修改 ([tasks.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/core/tasks.py))

1. **任务持久化到 Redis**
   - 使用现有的 `RedisClient` 进行任务状态存储
   - Redis Key 格式：`task:{task_id}`
   - 任务状态变更时同步写入 Redis
   - 任务过期时间：24 小时

2. **修改 `TaskManager` 类**
   - `create_task()`: 创建任务后写入 Redis
   - `update_progress()`: 更新进度后同步到 Redis
   - `start_task()`: 启动任务后更新 Redis 状态
   - `get_task()`: 优先从 Redis 读取，回退到内存
   - `list_tasks()`: 从 Redis 扫描所有任务键
   - `cleanup_completed_tasks()`: 清理 Redis 中的过期任务

3. **新增方法**
   - `_save_task_to_redis(task_info)`: 保存任务到 Redis
   - `_load_task_from_redis(task_id)`: 从 Redis 加载任务
   - `_delete_task_from_redis(task_id)`: 从 Redis 删除任务

---

## 问题二：删除人才后页面不更新

### 根因分析

在 [talents.js:479-495](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/talents.js#L479-L495) 的 `deleteTalent()` 方法中：

```javascript
if (response.success) {
    UI.toast('删除成功', 'success');
    await this.loadTalents();
    this.render();  // ❌ 问题：render() 只返回 HTML 字符串，不会更新 DOM
}
```

而正确的刷新方法在 [talents.js:458-465](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/talents.js#L458-L465)：

```javascript
async refresh() {
    await this.loadTalents();
    const container = document.getElementById('pageContainer');
    if (container) {
        container.innerHTML = this.renderContent();  // ✅ 正确更新 DOM
        this.initEvents();
    }
}
```

### 修复方案

**修改** [talents.js:487](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/talents.js#L487)：

将 `this.render()` 改为 `this.refresh()`

---

## 问题三：删除后去重阻止重新上传

### 根因分析

在 [talents.py:257-278](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/talents.py#L257-L278)（单文件上传）和 [talents.py:418-434](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/talents.py#L418-L434)（批量上传）中：

```python
existing_talent = await session.execute(
    select(TalentInfo).where(TalentInfo.content_hash == content_hash)
    # ❌ 问题：没有检查 is_deleted 状态
)
```

逻辑删除只设置 `is_deleted = True`，但 `content_hash` 字段保留，导致已删除的人才记录仍会被去重机制检测到。

### 修复方案

**修改** [talents.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/talents.py)：

1. **单文件上传去重检查**（约第 261 行）
   ```python
   existing_talent = await session.execute(
       select(TalentInfo).where(
           TalentInfo.content_hash == content_hash,
           TalentInfo.is_deleted == False  # 添加此条件
       )
   )
   ```

2. **批量上传去重检查**（约第 419 行）
   ```python
   existing_talent = await session.execute(
       select(TalentInfo).where(
           TalentInfo.content_hash == content_hash,
           TalentInfo.is_deleted == False  # 添加此条件
       )
   )
   ```

---

## 修改文件清单

| 文件 | 修改内容 |
|------|----------|
| `src/core/tasks.py` | 任务状态持久化到 Redis |
| `frontend-new/js/pages/upload.js` | 添加 localStorage 持久化、任务恢复逻辑 |
| `frontend-new/js/pages/talents.js` | 修复删除后调用 `refresh()` 而非 `render()` |
| `src/api/v1/talents.py` | 去重查询添加 `is_deleted == False` 条件 |

---

## 实施步骤

1. **修复问题二**（最简单）
   - 修改 `talents.js` 中 `deleteTalent()` 方法

2. **修复问题三**（中等复杂度）
   - 修改 `talents.py` 中两处去重查询

3. **修复问题一后端**（中等复杂度）
   - 修改 `tasks.py`，添加 Redis 持久化逻辑

4. **修复问题一前端**（最复杂）
   - 在 `upload.js` 中添加 localStorage 持久化逻辑
   - 添加任务恢复方法
   - 修改 `initEvents()` 方法

---

## 测试验证

1. **问题一测试**
   - 上传简历，观察进度显示
   - 刷新页面，验证进度是否恢复显示
   - 重启后端服务，验证任务状态是否保留
   - 任务完成后，验证进度容器是否正确隐藏

2. **问题二测试**
   - 在人才列表页面删除一条记录
   - 验证页面是否自动刷新，删除的记录是否消失

3. **问题三测试**
   - 上传一份简历
   - 删除该简历对应的人才记录
   - 再次上传同一份简历
   - 验证是否能够成功上传（不再被去重拦截）
