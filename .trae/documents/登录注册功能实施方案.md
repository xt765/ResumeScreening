# 登录注册功能实施方案

## 一、项目现状分析

### 1.1 技术栈
| 层级 | 技术选型 |
|------|---------|
| 后端框架 | FastAPI 0.120+ |
| ORM | SQLAlchemy 2.0+ (异步) |
| 数据库 | MySQL |
| 缓存 | Redis |
| 对象存储 | MinIO |
| 向量数据库 | ChromaDB |
| LLM 框架 | LangChain 1.2+ / LangGraph 1.0+ |
| 安全工具 | Fernet (AES) 加密 |

### 1.2 现有模型
- `TalentInfo` - 人才信息表
- `ScreeningCondition` - 筛选条件表
- **无用户相关模型**

### 1.3 现有 API
- `/api/v1/conditions` - 筛选条件管理
- `/api/v1/talents` - 人才管理
- `/api/v1/analysis` - 数据分析
- `/api/v1/monitor` - 系统监控
- **无认证相关 API**

### 1.4 前端现状
- 纯 HTML/CSS/JS 单页应用
- 基于 hash 的前端路由
- 无登录页面，直接进入系统
- 无用户状态管理

---

## 二、需求分析

### 2.1 目标用户
- HR / 招聘人员
- 人才管理部门
- 校园招聘团队

### 2.2 功能需求
1. **用户注册** - 新用户创建账号
2. **用户登录** - 已有用户登录系统
3. **登录状态保持** - Token 机制维持会话
4. **用户登出** - 退出登录状态
5. **路由守卫** - 未登录时跳转登录页

### 2.3 注册方式分析

**方案对比：**

| 方案 | 适用场景 | 优点 | 缺点 |
|------|---------|------|------|
| **开放注册** | 公开平台 | 用户自主注册，门槛低 | 用户质量不可控 |
| **管理员创建** | 企业内部 | 用户可控，安全高 | 管理员工作量大 |
| **邀请码注册** | 半公开平台 | 兼顾自主与可控 | 需要邀请码管理 |
| **邮箱验证注册** | 需要验证身份 | 确保邮箱真实 | 需要邮件服务 |

**推荐方案：管理员创建 + 首次登录修改密码**

理由：
1. **项目定位**：企业内部人才筛选系统，用户为 HR/招聘人员
2. **安全可控**：只有管理员可创建账号，避免未授权访问
3. **简洁高效**：无需邮件服务、无需邀请码管理
4. **符合企业场景**：新员工入职由管理员开通账号

**注册流程：**
```
管理员创建账号 → 用户收到初始密码 → 首次登录强制修改密码 → 正常使用
```

**角色权限：**
- `admin` - 管理员：可创建/管理用户、查看所有数据
- `hr` - HR 用户：可管理筛选条件、上传简历、查看人才
- `viewer` - 访客：仅可查看数据，不可修改

### 2.4 非功能需求
- 密码安全存储（bcrypt 哈希）
- JWT Token 认证
- Token 黑名单机制（Redis）
- 敏感信息保护

---

## 三、技术方案

### 3.1 认证方案选择

**方案对比：**

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| Session + Cookie | 简单、成熟 | 需要服务器存储、跨域问题 | 传统 Web 应用 |
| JWT Token | 无状态、跨域友好 | Token 无法主动失效 | 前后端分离、微服务 |
| JWT + Redis 黑名单 | 兼具两者优点 | 需要额外存储 | **本项目推荐** |

**选择：JWT + Redis 黑名单方案**

理由：
1. 项目已有 Redis 基础设施
2. 前后端分离架构，JWT 更合适
3. Redis 黑名单支持主动登出
4. 与现有架构无缝集成

### 3.2 数据模型设计

```python
# User 模型
class User(Base, TimestampMixin):
    __tablename__ = "user"
    
    id: str              # UUID 主键
    username: str        # 用户名（唯一）
    email: str           # 邮箱（唯一）
    password_hash: str   # 密码哈希（bcrypt）
    nickname: str        # 昵称
    role: str            # 角色：admin, hr, viewer
    is_active: bool      # 是否激活
    is_first_login: bool # 是否首次登录（首次登录强制修改密码）
    last_login: datetime # 最后登录时间
    created_at: datetime # 创建时间
    updated_at: datetime # 更新时间
```

### 3.3 API 设计

```
POST /api/v1/auth/login           # 用户登录
POST /api/v1/auth/logout          # 用户登出
GET  /api/v1/auth/me              # 获取当前用户信息
PUT  /api/v1/auth/password        # 修改密码（首次登录强制）

# 管理员接口（需要 admin 角色）
POST /api/v1/users                # 管理员创建用户
GET  /api/v1/users                # 获取用户列表
PUT  /api/v1/users/{id}           # 更新用户信息
DELETE /api/v1/users/{id}         # 禁用/删除用户
POST /api/v1/users/{id}/reset-password  # 重置用户密码
```

### 3.4 前端设计

**新增页面：**
- 登录页面 (`login.js`)
- 用户管理页面 (`users.js`) - 仅管理员可见

**路由改造：**
- 添加路由守卫，未登录时跳转登录页
- 登录后自动跳转原目标页面
- 首次登录强制跳转修改密码页面

**状态管理：**
- localStorage 存储 Token
- 全局用户状态管理

**侧边栏改造：**
- 显示当前用户信息
- 管理员显示"用户管理"菜单
- 登出按钮

---

## 四、实施计划

### 4.1 后端开发（Phase 1）

#### Step 1: 数据模型层
- [ ] 创建 `src/models/user.py` - User 模型
- [ ] 更新 `src/models/__init__.py` - 导出 User 模型

#### Step 2: Schema 层
- [ ] 创建 `src/schemas/user.py` - 用户相关 Schema
  - UserCreate - 管理员创建用户请求
  - UserLogin - 登录请求
  - UserResponse - 用户响应
  - TokenResponse - Token 响应
  - PasswordChange - 修改密码请求
  - UserUpdate - 更新用户请求

#### Step 3: 认证核心
- [ ] 创建 `src/core/auth.py` - 认证核心模块
  - 密码哈希/验证 (passlib)
  - JWT Token 生成/验证
  - Token 黑名单管理 (Redis)
  - 角色权限装饰器

#### Step 4: API 层
- [ ] 创建 `src/api/v1/auth.py` - 认证 API 路由
- [ ] 创建 `src/api/v1/users.py` - 用户管理 API 路由（管理员）
- [ ] 更新 `src/api/deps.py` - 添加当前用户依赖、角色权限依赖

#### Step 5: 集成
- [ ] 更新 `src/api/main.py` - 注册认证路由和用户管理路由
- [ ] 更新 `src/core/config.py` - 添加 JWT 配置
- [ ] 创建数据库迁移脚本 - 初始化管理员账号

### 4.2 前端开发（Phase 2）

#### Step 1: API 层
- [ ] 更新 `frontend-new/js/api.js` - 添加认证 API 和用户管理 API

#### Step 2: 页面组件
- [ ] 创建 `frontend-new/js/pages/login.js` - 登录页面
- [ ] 创建 `frontend-new/js/pages/users.js` - 用户管理页面（管理员）
- [ ] 创建修改密码模态框组件

#### Step 3: 路由改造
- [ ] 更新 `frontend-new/js/app.js` - 添加路由守卫
- [ ] 实现首次登录强制修改密码逻辑

#### Step 4: UI 更新
- [ ] 更新 `frontend-new/index.html` - 添加用户信息展示、登出按钮
- [ ] 更新 `frontend-new/css/style.css` - 登录页面样式
- [ ] 更新侧边栏 - 管理员显示用户管理菜单

### 4.3 测试（Phase 3）

#### Step 1: 单元测试
- [ ] 创建 `tests/unit/test_auth.py` - 认证模块测试
- [ ] 创建 `tests/unit/test_user_model.py` - 用户模型测试

#### Step 2: 集成测试
- [ ] 创建 `tests/integration/test_auth_api.py` - 认证 API 测试

---

## 五、技术细节

### 5.1 密码安全

```python
from passlib.context import CryptContext

pwd_context = CryptContext(
    schemes=["bcrypt"],
    deprecated="auto",
    bcrypt__rounds=12
)

def hash_password(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)
```

### 5.2 JWT Token

```python
from datetime import datetime, timedelta
from jose import jwt

def create_access_token(user_id: str, expires_delta: timedelta) -> str:
    payload = {
        "sub": user_id,
        "exp": datetime.utcnow() + expires_delta,
        "iat": datetime.utcnow(),
    }
    return jwt.encode(payload, SECRET_KEY, algorithm="HS256")
```

### 5.3 Token 黑名单

```python
# Redis 存储
async def add_token_to_blacklist(token: str, expires_in: int):
    await redis_client.set(f"blacklist:{token}", "1", ex=expires_in)

async def is_token_blacklisted(token: str) -> bool:
    return await redis_client.exists(f"blacklist:{token}")
```

### 5.4 路由守卫

```javascript
// 前端路由守卫
const publicPages = ['login', 'register'];

function checkAuth() {
    const token = localStorage.getItem('token');
    if (!token && !publicPages.includes(currentPage)) {
        Router.navigateTo('login');
        return false;
    }
    return true;
}
```

---

## 六、依赖变更

### 6.1 新增依赖

```toml
# pyproject.toml
dependencies = [
    # ... 现有依赖
    "python-jose[cryptography]>=3.3.0",  # JWT 处理
    "passlib[bcrypt]>=1.7.4",            # 密码哈希
]
```

### 6.2 配置变更

```python
# .env 新增配置
JWT_SECRET_KEY=your-secret-key-at-least-32-chars
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=1440  # 24小时
```

---

## 七、安全考虑

### 7.1 密码安全
- bcrypt 哈希，rounds=12
- 密码强度校验（长度、复杂度）
- 密码不以明文形式存储或传输

### 7.2 Token 安全
- Token 有效期 24 小时
- Token 存储在 localStorage（XSS 风险可控）
- 敏感操作需要重新验证

### 7.3 API 安全
- 登录失败次数限制（Redis 计数）
- 密码修改需要验证旧密码
- 所有 API 需要认证（除登录/注册）

---

## 八、文件清单

### 8.1 新增文件

```
src/
├── core/
│   └── auth.py                    # 认证核心模块
├── models/
│   └── user.py                    # 用户模型
├── schemas/
│   └── user.py                    # 用户 Schema
└── api/v1/
    ├── auth.py                    # 认证 API
    └── users.py                   # 用户管理 API（管理员）

scripts/
└── init_admin.py                  # 初始化管理员账号脚本

frontend-new/
└── js/pages/
    ├── login.js                   # 登录页面
    └── users.js                   # 用户管理页面（管理员）

tests/
├── unit/
│   ├── test_auth.py               # 认证模块测试
│   └── test_user_model.py         # 用户模型测试
└── integration/
    └── test_auth_api.py           # 认证 API 测试
```

### 8.2 修改文件

```
src/
├── api/main.py                    # 注册认证路由和用户管理路由
├── api/deps.py                    # 添加用户依赖、角色权限依赖
├── core/config.py                 # JWT 配置
└── models/__init__.py             # 导出 User

frontend-new/
├── index.html                     # 用户信息展示、登出按钮
├── css/style.css                  # 登录页面样式
└── js/
    ├── api.js                     # 认证 API 和用户管理 API
    └── app.js                     # 路由守卫

pyproject.toml                     # 新增依赖
```

---

## 九、增量更新策略

### 9.1 核心原则

**不破坏现有功能，渐进式添加认证模块**

1. **数据库增量** - 新增 `user` 表，不修改现有表结构
2. **API 增量** - 新增认证 API，现有 API 保持不变
3. **前端增量** - 新增登录页面，现有页面逻辑不变
4. **配置增量** - 新增 JWT 配置，现有配置保持不变

### 9.2 数据库迁移策略

```sql
-- 仅新增 user 表，不影响现有表
CREATE TABLE user (
    id CHAR(36) PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    nickname VARCHAR(50),
    role ENUM('admin', 'hr', 'viewer') DEFAULT 'hr',
    is_active BOOLEAN DEFAULT TRUE,
    is_first_login BOOLEAN DEFAULT TRUE,
    last_login DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 初始化默认管理员（可选）
INSERT INTO user (id, username, email, password_hash, nickname, role, is_first_login)
VALUES (UUID(), 'admin', 'admin@example.com', '<hashed_password>', '系统管理员', 'admin', FALSE);
```

### 9.3 API 兼容策略

**方案：可选认证（推荐）**

现有 API 暂不强制认证，新增认证后逐步启用：

```python
# deps.py - 新增可选认证依赖
async def get_current_user_optional(
    request: Request,
    session: AsyncSession = Depends(get_session),
) -> User | None:
    """可选认证：有 Token 则返回用户，无 Token 则返回 None"""
    token = request.headers.get("Authorization", "").replace("Bearer ", "")
    if not token:
        return None
    # 验证 Token...
    return user

# 现有 API 保持不变，可选使用认证
@router.get("/talents")
async def get_talents(
    user: User | None = Depends(get_current_user_optional),  # 可选
    session: AsyncSession = Depends(get_session),
):
    # 现有逻辑不变
    ...
```

**后续可逐步启用强制认证：**
```python
# 需要认证的 API
@router.post("/talents/upload-screen")
async def upload_screen(
    user: User = Depends(get_current_user_required),  # 强制认证
    ...
):
    ...
```

### 9.4 前端渐进策略

**阶段 1：添加登录页面（不强制）**
- 新增登录页面
- 登录后显示用户信息
- 未登录也可访问现有页面

**阶段 2：启用路由守卫（可选）**
- 配置哪些页面需要认证
- 默认不强制，可逐步启用

```javascript
// app.js - 可配置的认证要求
const PageConfig = {
    dashboard: { 
        title: '系统概览', 
        requireAuth: false,  // 不需要认证
        render: ... 
    },
    conditions: { 
        title: '筛选条件', 
        requireAuth: false,  // 暂不需要
        render: ... 
    },
    // 后续可逐步启用
    talents: { 
        title: '人才信息', 
        requireAuth: true,  // 需要认证
        render: ... 
    },
};
```

### 9.5 文件变更清单（增量）

**新增文件（不影响现有文件）：**
```
src/
├── core/auth.py           # 新增认证模块
├── models/user.py         # 新增用户模型
├── schemas/user.py        # 新增用户 Schema
└── api/v1/
    ├── auth.py            # 新增认证 API
    └── users.py           # 新增用户管理 API

scripts/
└── init_admin.py          # 新增初始化脚本

frontend-new/js/pages/
├── login.js               # 新增登录页面
└── users.js               # 新增用户管理页面
```

**修改文件（最小改动）：**
```
src/
├── api/main.py            # 仅添加路由注册（+2行）
├── api/deps.py            # 仅添加可选认证依赖（+20行）
├── core/config.py         # 仅添加 JWT 配置（+10行）
└── models/__init__.py     # 仅导出 User（+1行）

frontend-new/
├── index.html             # 添加用户信息区域（+10行）
├── css/style.css          # 添加登录样式（+50行）
└── js/
    ├── api.js             # 添加认证 API（+30行）
    └── app.js             # 添加路由守卫逻辑（+30行）

pyproject.toml             # 添加依赖（+2行）
```

---

## 十、总结

本方案采用 **JWT + Redis 黑名单** 认证机制，结合 **管理员创建用户** 的注册方式：

### 10.1 核心特点

1. **安全可控** - 只有管理员可创建账号，避免未授权访问
2. **简洁高效** - 无需邮件服务、无需邀请码管理
3. **首次登录保护** - 强制修改初始密码
4. **角色权限** - admin/hr/viewer 三级权限

### 10.2 增量更新保证

| 层级 | 变更方式 | 影响范围 |
|------|---------|---------|
| 数据库 | 新增 `user` 表 | 不影响现有表 |
| 后端 API | 新增认证 API | 现有 API 不变 |
| 前端页面 | 新增登录页面 | 现有页面不变 |
| 配置 | 新增 JWT 配置 | 现有配置不变 |

### 10.3 用户流程

```
┌─────────────────────────────────────────────────────────────┐
│                      管理员创建用户                          │
│  POST /api/v1/users {username, email, role, initial_password}│
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      用户首次登录                            │
│  POST /api/v1/auth/login → 返回 is_first_login: true        │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    强制修改密码                              │
│  PUT /api/v1/auth/password {old_password, new_password}     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      正常使用系统                            │
│  携带 Token 访问各功能 API                                   │
└─────────────────────────────────────────────────────────────┘
```

### 10.4 技术亮点

- **bcrypt 密码哈希** - 安全存储密码
- **JWT Token** - 无状态认证，跨域友好
- **Redis 黑名单** - 支持主动登出
- **角色权限装饰器** - 细粒度权限控制
- **可选认证** - 渐进式启用，不破坏现有功能

实施顺序：后端模型 → 后端 API → 前端页面 → 测试覆盖
