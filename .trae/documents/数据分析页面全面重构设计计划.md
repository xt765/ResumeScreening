# 数据分析页面全面重构设计计划

## 一、问题分析与评估

### 1.1 RAG智能查询检索已删除数据的根本原因

#### 问题现象
当人才被逻辑删除后，RAG查询仍然会返回这些已删除的人才信息。

#### 根本原因分析

**原因一：ChromaDB元数据缺失 `is_deleted` 字段**

当前向量存储逻辑位于 [store_node.py:94-103](file:///d:/Documents/CodeProjects/ResumeScreening/src/workflows/store_node.py#L94-L103)：

```python
metadata = {
    "name": candidate_info.get("name", ""),
    "school": candidate_info.get("school", ""),
    "major": candidate_info.get("major", ""),
    "education_level": candidate_info.get("education_level", ""),
    "work_years": candidate_info.get("work_years", 0),
    "skills": ",".join(candidate_info.get("skills", [])),
    "created_at": datetime.now().isoformat(),
    # ⚠️ 缺少 is_deleted 字段
}
```

**原因二：RAG查询未添加过滤条件**

当前查询逻辑位于 [analysis.py:100-104](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/analysis.py#L100-L104)：

```python
results = chroma_client.query(
    query_texts=[request.query],
    n_results=request.top_k,
    where=request.filters,  # ⚠️ 未添加 is_deleted 过滤
)
```

**原因三：逻辑删除未同步ChromaDB**

当前删除逻辑位于 [talents.py:1107](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/talents.py#L1107)：

```python
talent.is_deleted = True
await session.commit()
# ⚠️ 未同步更新 ChromaDB 向量
```

### 1.2 数据分析结论与RAG查询结果脱节的根本原因

#### 问题现象
RAG查询只返回向量检索结果，没有生成智能分析结论。

#### 根本原因分析

**原因一：API未使用RAGService**

当前API直接调用 `chroma_client.query()` 而非 `RAGService.query()`。

对比两个方法：

| 方法 | 功能 | 是否生成结论 |
|------|------|--------------|
| `chroma_client.query()` | 仅向量检索 | ❌ |
| `RAGService.query()` | 向量检索 + LLM生成答案 | ✅ |

**原因二：RAGService未被正确集成**

[RAGService](file:///d:/Documents/CodeProjects/ResumeScreening/src/utils/rag_service.py) 提供了完整的RAG功能：

```python
async def query(self, question: str, top_k: int = 5, filters: dict | None = None) -> dict[str, Any]:
    """执行 RAG 查询，返回包含答案和来源的字典"""
    context_docs = await self._retrieve(question, top_k, filters)
    answer = await self._generate_answer(question, context_docs)
    return {
        "answer": answer,      # 生成的分析结论 ⭐
        "sources": context_docs,
        "elapsed_time_ms": elapsed_time,
    }
```

但API端点完全未调用此服务。

### 1.3 当前数据流向分析

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        LangGraph 工作流                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐              │
│  │ParseExtractNode│──▶│  FilterNode  │──▶│  StoreNode   │              │
│  │  解析文档      │    │  LLM筛选判断  │    │  数据入库     │              │
│  └──────────────┘    └──────────────┘    └──────┬───────┘              │
│                                                  │                      │
│                          ┌───────────────────────┼──────────┐           │
│                          ▼                       ▼          ▼           │
│                    ┌──────────┐           ┌──────────┐ ┌──────────┐    │
│                    │  MySQL   │           │  MinIO   │ │ ChromaDB │    │
│                    │ 人才信息  │           │ 图片存储  │ │ 向量存储  │    │
│                    │is_deleted│           │          │ │ ⚠️无is_deleted│  │
│                    └────┬─────┘           └──────────┘ └────┬─────┘    │
│                         │                                  │           │
│                         │ 逻辑删除                          │ 未同步     │
│                         ▼                                  ▼           │
│                    ┌──────────┐                      ┌──────────┐      │
│                    │ is_deleted│                     │ 查询返回  │      │
│                    │  = True   │                     │ 已删除数据│      │
│                    └──────────┘                      └──────────┘      │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.4 组件交互关系

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              前端                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐  │
│  │  analysis.js     │    │     api.js       │    │    app.js        │  │
│  │  - executeQuery()│───▶│  - analysisApi   │───▶│  - 路由管理       │  │
│  │  - showResults() │    │  - talentsApi    │    │  - 状态管理       │  │
│  └──────────────────┘    └────────┬─────────┘    └──────────────────┘  │
│                                   │                                     │
└───────────────────────────────────┼─────────────────────────────────────┘
                                    │ HTTP
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                              后端                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐  │
│  │  analysis.py     │    │   talents.py     │    │  rag_service.py  │  │
│  │  - rag_query()   │    │  - delete_talent │    │  - query()       │  │
│  │  ⚠️直接调用chroma │    │  ⚠️未同步向量     │    │  ⚠️未被使用      │  │
│  └────────┬─────────┘    └────────┬─────────┘    └──────────────────┘  │
│           │                       │                                     │
│           ▼                       ▼                                     │
│  ┌──────────────────┐    ┌──────────────────┐                          │
│  │  chroma_client   │    │     MySQL        │                          │
│  │  - query()       │    │  - is_deleted    │                          │
│  │  ⚠️无过滤条件     │    │                  │                          │
│  └──────────────────┘    └──────────────────┘                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 二、功能优化设计

### 2.1 RAG智能查询重构设计

#### 2.1.1 向量数据生命周期管理

**设计目标**：确保ChromaDB与MySQL数据状态同步

**方案设计**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     向量数据生命周期管理                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌──────────────┐                                                       │
│  │  新增人才     │──▶ ChromaDB.add_documents(metadata={is_deleted=False})│
│  └──────────────┘                                                       │
│                                                                         │
│  ┌──────────────┐                                                       │
│  │  逻辑删除     │──▶ ChromaDB.update_documents(metadata={is_deleted=True})│
│  └──────────────┘                                                       │
│                                                                         │
│  ┌──────────────┐                                                       │
│  │  恢复人才     │──▶ ChromaDB.update_documents(metadata={is_deleted=False})│
│  │              │    或重新向量化（如果向量不存在）                        │
│  └──────────────┘                                                       │
│                                                                         │
│  ┌──────────────┐                                                       │
│  │  RAG查询     │──▶ ChromaDB.query(where={is_deleted: False})          │
│  └──────────────┘                                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.1.2 RAG查询流程重构

**当前流程**：
```
用户查询 → chroma_client.query() → 返回向量检索结果
```

**重构后流程**：
```
用户查询 → RAGService.query() → 向量检索(where={is_deleted: False}) → LLM生成答案 → 返回{answer, sources}
```

#### 2.1.3 API响应模型重构

**当前模型**：
```python
class QueryResult(BaseModel):
    id: str
    content: str
    metadata: dict[str, Any]
    distance: float | None
```

**重构后模型**：
```python
class RAGQueryResponse(BaseModel):
    """RAG查询响应模型"""
    answer: str                              # LLM生成的分析结论
    sources: list[QueryResult]               # 检索来源
    elapsed_time_ms: int                     # 查询耗时
    query_id: str                            # 查询ID（用于追踪）

class QueryResult(BaseModel):
    """查询结果模型"""
    id: str
    content: str
    metadata: dict[str, Any]
    distance: float | None
    similarity_score: float | None           # 相似度分数（0-1）
```

### 2.2 数据分析结论与查询结果关联机制

#### 2.2.1 关联机制设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     分析结论与查询结果关联                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  用户输入查询                                                            │
│       │                                                                 │
│       ▼                                                                 │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    RAGService.query()                            │  │
│  │  ┌────────────────┐    ┌────────────────┐    ┌────────────────┐  │  │
│  │  │  向量检索       │───▶│  上下文构建     │───▶│  LLM生成答案   │  │  │
│  │  │  (过滤已删除)   │    │  (来源标注)     │    │  (引用来源)    │  │  │
│  │  └────────────────┘    └────────────────┘    └────────────────┘  │  │
│  │           │                    │                    │            │  │
│  │           ▼                    ▼                    ▼            │  │
│  │  ┌─────────────────────────────────────────────────────────────┐ │  │
│  │  │                      sources (来源列表)                      │ │  │
│  │  │  - id: talent_id                                            │ │  │
│  │  │  - content: 简历内容                                        │ │  │
│  │  │  - metadata: {name, school, ...}                           │ │  │
│  │  │  - relevance_score: 相关性分数                              │ │  │
│  │  └─────────────────────────────────────────────────────────────┘ │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│       │                                                                 │
│       ▼                                                                 │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                      前端展示                                     │  │
│  │  ┌────────────────┐    ┌────────────────┐                        │  │
│  │  │  分析结论卡片   │    │  来源列表卡片   │                        │  │
│  │  │  (LLM生成答案)  │    │  (可点击查看)   │                        │  │
│  │  └────────────────┘    └────────────────┘                        │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 分析结论生成Prompt优化

**当前Prompt**（位于 [rag_service.py:167-174](file:///d:/Documents/CodeProjects/ResumeScreening/src/utils/rag_service.py#L167-L174)）：

```python
system_prompt = """你是一个专业的简历筛选助手，帮助用户查询和分析候选人信息。
请根据提供的候选人资料，准确回答用户的问题。

回答要求：
1. 基于提供的候选人资料回答，不要编造信息
2. 如果资料中没有相关信息，请明确说明
3. 回答要简洁、专业、准确
4. 可以适当总结和分析，但不要过度解读"""
```

**优化后Prompt**：

```python
system_prompt = """你是一个专业的简历筛选助手，帮助用户查询和分析候选人信息。

## 核心职责
1. 基于提供的候选人资料回答问题，严禁编造信息
2. 在回答中明确标注信息来源（使用[候选人X]格式引用）
3. 提供数据驱动的分析结论

## 回答格式
### 分析结论
[主要回答内容，引用来源如：根据[候选人1]的简历...]

### 候选人概览
[如涉及多个候选人，提供简要对比]

### 建议
[基于分析给出招聘建议]

## 注意事项
- 如果资料中没有相关信息，明确说明"根据现有资料未找到相关信息"
- 数值类信息需精确引用，如工作年限、学历等
- 技能匹配度分析需基于简历实际内容"""
```

### 2.3 数据分析图表展示优化

#### 2.3.1 图表库选型

**推荐方案**：ECharts

**选型理由**：
- 功能丰富，支持多种图表类型
- 响应式设计，适配不同屏幕
- 支持数据下钻和多维度分析
- 中文文档完善

#### 2.3.2 图表设计方案

**统计维度扩展**：

| 维度 | 图表类型 | 功能 |
|------|----------|------|
| 筛选状态分布 | 饼图 | 展示通过/未通过比例 |
| 工作流状态分布 | 柱状图 | 展示各状态数量 |
| 学历分布 | 柱状图 | 展示各学历层次人数 |
| 技能云图 | 词云 | 展示热门技能 |
| 入库趋势 | 折线图 | 展示近30天入库趋势 |
| 工作经验分布 | 柱状图 | 展示工作年限分布 |

**图表布局设计**：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          数据分析仪表板                                   │
├─────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │   人才总数       │  │   近7天新增      │  │   通过率        │         │
│  │   [大数字]       │  │   [大数字]       │  │   [大数字%]     │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
│                                                                         │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐      │
│  │     筛选状态分布（饼图）      │  │     工作流状态（柱状图）      │      │
│  │                             │  │                             │      │
│  └─────────────────────────────┘  └─────────────────────────────┘      │
│                                                                         │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐      │
│  │     学历分布（柱状图）        │  │     技能云图                 │      │
│  │                             │  │                             │      │
│  └─────────────────────────────┘  └─────────────────────────────┘      │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    入库趋势（折线图）                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.3.3 数据下钻功能设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          数据下钻流程                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  点击图表元素                                                            │
│       │                                                                 │
│       ▼                                                                 │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    显示下钻面板                                   │  │
│  │  ┌────────────────────────────────────────────────────────────┐  │  │
│  │  │  筛选条件：[学历: 硕士] [状态: 通过]                         │  │  │
│  │  │  数量：25 人                                                │  │  │
│  │  │  操作：[查看列表] [导出数据] [RAG分析]                       │  │  │
│  │  └────────────────────────────────────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│       │                                                                 │
│       ▼                                                                 │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                    RAG智能分析                                    │  │
│  │  自动生成查询："分析所有硕士学历且通过筛选的候选人特点"            │  │
│  │  返回：分析结论 + 候选人列表                                      │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、技术实现方案

### 3.1 后端实现方案

#### 3.1.1 ChromaDB元数据扩展

**修改文件**：[store_node.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/workflows/store_node.py)

**修改内容**：

```python
def _store_to_chromadb(
    talent_id: str,
    resume_text: str,
    candidate_info: dict[str, Any],
) -> bool:
    """存储简历向量到 ChromaDB。"""
    if not resume_text:
        logger.warning("简历文本为空，跳过向量存储")
        return False

    try:
        metadata = {
            "name": candidate_info.get("name", ""),
            "school": candidate_info.get("school", ""),
            "major": candidate_info.get("major", ""),
            "education_level": candidate_info.get("education_level", ""),
            "work_years": candidate_info.get("work_years", 0),
            "skills": ",".join(candidate_info.get("skills", [])),
            "created_at": datetime.now().isoformat(),
            "is_deleted": False,  # 新增：逻辑删除标记
            "screening_status": "qualified" if candidate_info.get("is_qualified") else "unqualified",
        }

        chroma_client.add_documents(
            ids=[talent_id],
            documents=[resume_text],
            metadatas=[metadata],
        )

        logger.info(f"向量存储成功: talent_id={talent_id}")
        return True
    except Exception as e:
        logger.exception(f"向量存储失败: {e}")
        raise StorageException(...)
```

#### 3.1.2 逻辑删除同步ChromaDB

**修改文件**：[talents.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/talents.py)

**修改内容**：

```python
@router.delete("/{talent_id}")
async def delete_talent(
    talent_id: str,
    session: Annotated[AsyncSession, Depends(get_session)],
) -> APIResponse[dict[str, Any]]:
    """逻辑删除人才（同步更新ChromaDB）。"""
    logger.info(f"逻辑删除人才: id={talent_id}")

    try:
        # 1. 查询人才
        query = select(TalentInfo).where(TalentInfo.id == talent_id)
        result = await session.execute(query)
        talent = result.scalar_one_or_none()

        if not talent:
            raise HTTPException(status_code=404, detail=f"人才不存在: {talent_id}")

        if talent.is_deleted:
            return APIResponse(success=True, message="人才已被删除", data={"id": talent_id, "is_deleted": True})

        # 2. 更新MySQL
        talent.is_deleted = True
        await session.commit()

        # 3. 同步更新ChromaDB元数据
        try:
            chroma_client.update_documents(
                ids=[talent_id],
                metadatas=[{"is_deleted": True}],
            )
            logger.info(f"ChromaDB同步删除成功: id={talent_id}")
        except Exception as e:
            logger.warning(f"ChromaDB同步失败（不影响主流程）: {e}")

        logger.success(f"逻辑删除成功: id={talent_id}")
        return APIResponse(success=True, message="删除成功", data={"id": talent_id, "is_deleted": True})

    except HTTPException:
        raise
    except Exception as e:
        logger.exception(f"删除人才失败: {e}")
        await session.rollback()
        raise HTTPException(status_code=500, detail=f"删除人才失败: {e}") from None


@router.post("/{talent_id}/restore")
async def restore_talent(
    talent_id: str,
    session: Annotated[AsyncSession, Depends(get_session)],
) -> APIResponse[dict[str, Any]]:
    """恢复已删除的人才（同步更新ChromaDB）。"""
    logger.info(f"恢复人才: id={talent_id}")

    try:
        # 1. 查询人才
        query = select(TalentInfo).where(TalentInfo.id == talent_id)
        result = await session.execute(query)
        talent = result.scalar_one_or_none()

        if not talent:
            raise HTTPException(status_code=404, detail=f"人才不存在: {talent_id}")

        if not talent.is_deleted:
            return APIResponse(success=True, message="人才未被删除", data={"id": talent_id, "is_deleted": False})

        # 2. 更新MySQL
        talent.is_deleted = False
        await session.commit()

        # 3. 同步更新ChromaDB
        try:
            # 检查向量是否存在
            existing = chroma_client.get_documents(ids=[talent_id])
            if existing.get("ids"):
                # 更新元数据
                chroma_client.update_documents(
                    ids=[talent_id],
                    metadatas=[{"is_deleted": False}],
                )
            else:
                # 向量不存在，需要重新向量化
                logger.warning(f"向量不存在，需要重新向量化: id={talent_id}")
                # 可以触发异步向量化任务
        except Exception as e:
            logger.warning(f"ChromaDB同步失败（不影响主流程）: {e}")

        logger.success(f"恢复人才成功: id={talent_id}")
        return APIResponse(success=True, message="恢复成功", data={"id": talent_id, "is_deleted": False})

    except HTTPException:
        raise
    except Exception as e:
        logger.exception(f"恢复人才失败: {e}")
        await session.rollback()
        raise HTTPException(status_code=500, detail=f"恢复人才失败: {e}") from None
```

#### 3.1.3 RAG查询API重构

**修改文件**：[analysis.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/analysis.py)

**修改内容**：

```python
from src.utils.rag_service import get_rag_service

class RAGQueryResponse(BaseModel):
    """RAG查询响应模型。"""
    answer: str = Field(..., description="LLM生成的分析结论")
    sources: list[QueryResult] = Field(default_factory=list, description="检索来源")
    elapsed_time_ms: int = Field(..., description="查询耗时(ms)")
    query_id: str = Field(..., description="查询ID")


@router.post(
    "/query",
    response_model=APIResponse[RAGQueryResponse],
    summary="RAG智能查询",
    description="基于向量检索和LLM生成的人才简历智能问答",
)
async def rag_query(request: QueryRequest) -> APIResponse[RAGQueryResponse]:
    """执行RAG智能查询。

    结合向量检索和LLM生成，返回分析结论和来源。
    """
    logger.info(f"执行RAG查询: query={request.query[:50]}..., top_k={request.top_k}")

    try:
        # 构建过滤条件（强制过滤已删除数据）
        filters = request.filters or {}
        filters["is_deleted"] = False

        # 调用RAG服务
        rag_service = get_rag_service()
        result = await rag_service.query(
            question=request.query,
            top_k=request.top_k,
            filters=filters,
        )

        # 构建响应
        sources = [
            QueryResult(
                id=doc["id"],
                content=doc["content"],
                metadata=doc["metadata"],
                distance=doc.get("distance"),
                similarity_score=_calculate_similarity(doc.get("distance")),
            )
            for doc in result["sources"]
        ]

        response = RAGQueryResponse(
            answer=result["answer"],
            sources=sources,
            elapsed_time_ms=result["elapsed_time_ms"],
            query_id=str(uuid4()),
        )

        logger.success(f"RAG查询完成: sources={len(sources)}, elapsed={result['elapsed_time_ms']}ms")

        return APIResponse(
            success=True,
            message="查询成功",
            data=response,
        )

    except LLMException as e:
        logger.error(f"LLM调用失败: {e}")
        raise HTTPException(status_code=503, detail=f"LLM服务暂不可用: {e}") from None
    except Exception as e:
        logger.exception(f"RAG查询失败: {e}")
        raise HTTPException(status_code=500, detail=f"查询失败: {e}") from None


def _calculate_similarity(distance: float | None) -> float | None:
    """计算相似度分数（0-1）。

    将距离转换为相似度，使用余弦相似度公式。
    """
    if distance is None:
        return None
    # 假设使用余弦距离，相似度 = 1 - distance
    # 如果使用L2距离，需要归一化处理
    return max(0.0, min(1.0, 1 - distance))
```

#### 3.1.4 统计数据扩展

**修改文件**：[analysis.py](file:///d:/Documents/CodeProjects/ResumeScreening/src/api/v1/analysis.py)

**扩展统计维度**：

```python
class ExtendedStatisticsResponse(BaseModel):
    """扩展统计数据响应模型。"""
    # 基础统计
    total_talents: int
    recent_7_days: int
    pass_rate: float

    # 状态分布
    by_screening_status: dict[str, int]
    by_workflow_status: dict[str, int]

    # 新增维度
    by_education_level: dict[str, int]      # 学历分布
    by_work_years_range: dict[str, int]     # 工作年限分布
    top_skills: list[dict[str, Any]]        # 热门技能Top10
    daily_trend: list[dict[str, Any]]       # 近30天入库趋势


@router.get("/statistics")
async def get_statistics(
    session: Annotated[AsyncSession, Depends(get_session)],
) -> APIResponse[ExtendedStatisticsResponse]:
    """获取扩展统计数据。"""
    # ... 实现扩展统计逻辑
```

### 3.2 前端实现方案

#### 3.2.1 引入ECharts

**修改文件**：[index.html](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/index.html)

```html
<!-- 引入ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
```

#### 3.2.2 数据分析页面重构

**修改文件**：[analysis.js](file:///d:/Documents/CodeProjects/ResumeScreening/frontend-new/js/pages/analysis.js)

**核心改动**：

1. **RAG查询结果展示**：
```javascript
async executeQuery() {
    const query = queryInput.value.trim();
    if (!query) {
        UI.toast('请输入查询内容', 'warning');
        return;
    }

    try {
        UI.showLoading();
        const response = await analysisApi.query(query, topK);

        if (response.success) {
            const data = response.data;
            this.showRAGResult(data);  // 新方法：展示RAG结果
            UI.toast(`查询完成，耗时 ${data.elapsed_time_ms}ms`, 'success');
        }
    } catch (error) {
        UI.toast(error.message || '查询失败', 'error');
    } finally {
        UI.hideLoading();
    }
}

showRAGResult(data) {
    const resultsCard = document.getElementById('resultsCard');
    resultsCard.style.display = 'block';

    resultsCard.innerHTML = `
        <!-- 分析结论卡片 -->
        <div class="analysis-conclusion">
            <h4>分析结论</h4>
            <div class="conclusion-content">
                ${this.formatAnswer(data.answer)}
            </div>
        </div>

        <!-- 来源列表 -->
        <div class="analysis-sources">
            <h4>参考来源 (${data.sources.length}条)</h4>
            <div class="sources-list">
                ${data.sources.map((source, index) => this.renderSourceItem(source, index)).join('')}
            </div>
        </div>
    `;
}
```

2. **图表渲染**：
```javascript
renderCharts() {
    this.renderScreeningPieChart();
    this.renderWorkflowBarChart();
    this.renderEducationChart();
    this.renderSkillsCloud();
    this.renderTrendLineChart();
}

renderScreeningPieChart() {
    const chart = echarts.init(document.getElementById('screeningPieChart'));
    const option = {
        title: { text: '筛选状态分布', left: 'center' },
        tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)' },
        legend: { orient: 'vertical', left: 'left' },
        series: [{
            type: 'pie',
            radius: '50%',
            data: [
                { value: this.statistics.by_screening_status.qualified || 0, name: '通过', itemStyle: { color: '#10b981' } },
                { value: this.statistics.by_screening_status.unqualified || 0, name: '未通过', itemStyle: { color: '#ef4444' } },
            ],
            emphasis: {
                itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
            }
        }]
    };
    chart.setOption(option);
}
```

#### 3.2.3 数据下钻功能

```javascript
handleChartClick(params) {
    // 显示下钻面板
    const drillDownPanel = document.getElementById('drillDownPanel');
    drillDownPanel.style.display = 'block';

    // 构建筛选条件
    const filters = this.buildFiltersFromClick(params);

    // 显示筛选结果
    this.showDrillDownResults(filters);
}

async showDrillDownResults(filters) {
    // 自动生成RAG查询
    const query = this.generateQueryFromFilters(filters);
    const response = await analysisApi.query(query, 20, filters);

    // 展示结果
    this.showRAGResult(response.data);
}
```

---

## 四、质量保障方案

### 4.1 测试计划

#### 4.1.1 单元测试

| 测试模块 | 测试内容 | 覆盖目标 |
|----------|----------|----------|
| `test_chroma_sync` | ChromaDB元数据同步 | 100% |
| `test_rag_service` | RAG服务查询逻辑 | 100% |
| `test_analysis_api` | 分析API端点 | 100% |
| `test_statistics` | 统计数据计算 | 100% |

#### 4.1.2 集成测试

| 测试场景 | 测试内容 |
|----------|----------|
| 删除同步 | 删除人才后RAG查询不返回该数据 |
| 恢复同步 | 恢复人才后RAG查询可检索该数据 |
| RAG查询 | 查询返回分析结论和来源 |
| 图表交互 | 图表点击触发下钻 |

#### 4.1.3 用户验收测试

| 测试用例 | 预期结果 |
|----------|----------|
| 执行RAG查询 | 显示分析结论和来源列表 |
| 点击图表元素 | 显示下钻面板和筛选结果 |
| 删除人才后查询 | 不返回已删除数据 |
| 查看统计图表 | 图表清晰、数据准确 |

### 4.2 数据准确性验证

```python
async def verify_data_consistency():
    """验证MySQL和ChromaDB数据一致性。"""
    # 1. 获取MySQL中所有未删除人才ID
    mysql_ids = await get_active_talent_ids()

    # 2. 获取ChromaDB中is_deleted=False的ID
    chroma_result = chroma_client.get_documents(where={"is_deleted": False})
    chroma_ids = chroma_result.get("ids", [])

    # 3. 对比差异
    missing_in_chroma = set(mysql_ids) - set(chroma_ids)
    extra_in_chroma = set(chroma_ids) - set(mysql_ids)

    if missing_in_chroma:
        logger.warning(f"ChromaDB缺失数据: {missing_in_chroma}")
    if extra_in_chroma:
        logger.warning(f"ChromaDB多余数据: {extra_in_chroma}")

    return len(missing_in_chroma) == 0 and len(extra_in_chroma) == 0
```

### 4.3 性能优化方案

| 优化项 | 方案 | 预期效果 |
|--------|------|----------|
| 向量查询 | 添加索引、限制返回字段 | 查询时间 < 500ms |
| 统计缓存 | Redis缓存统计结果 | 缓存命中时 < 50ms |
| 图表渲染 | 懒加载、虚拟滚动 | 首屏时间 < 1s |
| LLM调用 | 流式输出、超时控制 | 响应时间 < 10s |

---

## 五、实施计划

### 5.1 任务分解

| 阶段 | 任务 | 优先级 | 预估工作量 |
|------|------|--------|------------|
| **阶段一** | 后端核心修复 | P0 | 2天 |
| | 1.1 ChromaDB元数据扩展 | P0 | 0.5天 |
| | 1.2 删除/恢复同步逻辑 | P0 | 0.5天 |
| | 1.3 RAG查询API重构 | P0 | 1天 |
| **阶段二** | 前端重构 | P1 | 2天 |
| | 2.1 引入ECharts | P1 | 0.5天 |
| | 2.2 图表组件开发 | P1 | 1天 |
| | 2.3 RAG结果展示优化 | P1 | 0.5天 |
| **阶段三** | 扩展功能 | P2 | 1天 |
| | 3.1 统计维度扩展 | P2 | 0.5天 |
| | 3.2 数据下钻功能 | P2 | 0.5天 |
| **阶段四** | 测试与优化 | P0 | 1天 |
| | 4.1 单元测试 | P0 | 0.5天 |
| | 4.2 集成测试 | P0 | 0.5天 |

### 5.2 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 现有向量数据迁移 | 中 | 提供数据迁移脚本 |
| LLM服务不稳定 | 高 | 添加降级策略（仅返回检索结果） |
| 图表性能问题 | 低 | 数据分页、虚拟滚动 |

---

## 六、交付成果清单

### 6.1 设计文档
- [x] 架构设计文档（本文档）
- [ ] 数据流图
- [ ] API接口文档

### 6.2 代码交付
- [ ] 后端代码修改
  - [ ] `src/workflows/store_node.py` - 元数据扩展
  - [ ] `src/api/v1/talents.py` - 删除/恢复同步
  - [ ] `src/api/v1/analysis.py` - RAG查询重构
  - [ ] `src/utils/rag_service.py` - Prompt优化
- [ ] 前端代码修改
  - [ ] `frontend-new/index.html` - 引入ECharts
  - [ ] `frontend-new/js/pages/analysis.js` - 页面重构
  - [ ] `frontend-new/js/api.js` - API适配

### 6.3 测试交付
- [ ] 单元测试代码
- [ ] 集成测试代码
- [ ] 测试报告

### 6.4 其他交付
- [ ] 数据迁移脚本
- [ ] 用户操作手册
- [ ] 维护文档

---

## 七、附录

### 附录A：相关文件路径汇总

| 文件 | 路径 | 说明 |
|------|------|------|
| RAG服务 | `src/utils/rag_service.py` | RAG智能问答服务 |
| 分析API | `src/api/v1/analysis.py` | 数据分析API端点 |
| 人才API | `src/api/v1/talents.py` | 人才管理API |
| 存储节点 | `src/workflows/store_node.py` | 向量存储逻辑 |
| ChromaDB客户端 | `src/storage/chroma_client.py` | 向量数据库封装 |
| 前端分析页 | `frontend-new/js/pages/analysis.js` | 数据分析页面 |
| 前端API | `frontend-new/js/api.js` | API调用封装 |

### 附录B：ChromaDB where过滤语法

```python
# 等于
where = {"is_deleted": False}

# 组合条件
where = {
    "$and": [
        {"is_deleted": False},
        {"education_level": "master"}
    ]
}

# 或条件
where = {
    "$or": [
        {"education_level": "master"},
        {"education_level": "doctor"}
    ]
}

# 范围条件
where = {
    "$and": [
        {"is_deleted": False},
        {"work_years": {"$gte": 3}}
    ]
}
```
